<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Knowify Room - {{ room_id }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" href="/static/styles.css">
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
</head>
<body>
  <audio id="buzzerSound" src="/static/buzzer.mp3" preload="auto"></audio>

  <div class="container">
    <h1>Room: {{ room_id }}</h1>
    <h3>Welcome, {{ name }} ({{ role.upper() }})</h3>

    <!-- USER: TEAMS JOINED -->
    <div class="card" style="background: #f5faff;">
      <h2>ğŸ‘¥ Teams Joined</h2>
      <p id="teamList">None</p>
    </div>

    <!-- USER: ROUND DETAILS -->
    <div class="card">
      <h2>ğŸ“‹ Round Details</h2>
      <div id="userRoundDetails">
        <p>
          <strong>Round Name:</strong> -<br />
          <strong>Type:</strong> -<br />
          <strong>No. of Questions:</strong> -<br />
          <strong>Marking:</strong> -
        </p>
      </div>
    </div>

    <!-- ADMIN CONTROLS -->
    <div class="card" id="adminControls" style="display: none;">
      <h2>ğŸ§  Admin Panel</h2>

      <div class="section-title">ğŸ§¾ Round Details</div>
      <input type="text" id="roundNameInput" placeholder="Round Name" />
      <input type="number" id="numQuestionsInput" placeholder="No. of Questions" />
      <input type="text" id="markingInput" placeholder="Marking Scheme (e.g., +10, -5)" />
      <label>Round Type:</label>
      <select id="qType">
        <option value="infinite">Infinite Pounce</option>
        <option value="buzzer">Buzzer Round</option>
        <option value="direct">Direct Question</option>
      </select>
      <button class="btn-sm" onclick="saveRoundDetails()">ğŸ’¾ Save Round Details</button>


      <div class="section-title">ğŸ”” Buzzer</div>
      <button class="btn-sm" onclick="startBuzzer()">â–¶ï¸ Start</button>
      <button class="btn-sm" onclick="stopBuzzer()">â¸ï¸ Stop</button>
      <button class="btn-sm" onclick="reset()">ğŸ”„ Reset</button>

      <div class="section-title">â“ Question Controls</div>
      <input id="questionSeconds" type="number" placeholder="Timer (sec)">
      <button class="btn-sm" onclick="startQuestionTimer()">â–¶ï¸ Start</button>
      <button class="btn-sm" onclick="stopQuestionTimer()">â¹ï¸ Stop</button>
      <br />
      <label>Set Active Team:</label>
      <select id="activeTeamDropdown"></select>
      <button class="btn-sm" onclick="setActive()">ğŸ¯ Set</button>
      <br />
      <button class="btn-sm" onclick="resetQuestion()">ğŸ—‘ï¸ Reset Question</button>


      <div class="section-title">ğŸ† Score Keeper</div>
      <select id="awardTeamDropdown"></select>
      <input id="points" type="number" placeholder="Points" />
      <button class="btn-sm" onclick="award()">âœ… Update</button>
    </div>

    <!-- USER: BUZZ -->
    <div class="card" id="buzzSection">
      <h2>Buzzer</h2>
      <button class="btn-sm" onclick="buzz()" id="buzzBtn">ğŸ”” BUZZ</button>
      <span id="buzzerStatus" style="margin-left: 1rem;">â›”</span>
    </div>

    <!-- SCOREBOARD -->
    <div class="card">
      <h2>ğŸ“Š Scoreboard</h2>
      <ul id="scoreboard" class="scoreboard-list"></ul>
    </div>

    <!-- BUZZ ORDER -->
    <div class="card">
      <h2>ğŸ”” Buzz Order</h2>
      <ul id="buzzOrderList" class="scoreboard-list"></ul>
    </div>
  </div>

  <!-- FLOATING TIMER -->
  <div id="floatingTimerBox">
    ğŸ•‘ <span id="questionTimer">0</span> sec |
    ğŸ¯ Active: <span id="activeDisplay">-</span>
  </div>

  <script>
    const role = "{{ role }}";
    const team = "{{ team }}";
    const room = "{{ room_id }}";
    const name = "{{ name }}";
    const socket = io();
    let questionCountdown = null;

    socket.emit('join', { room, team: role === "admin" ? null : team });

    if (role === "admin") {
      document.getElementById('adminControls').style.display = 'block';
      document.getElementById('buzzSection').style.display = 'none';
    }

    function buzz() {
      if (!team) return alert("Only team members can buzz.");
      socket.emit('buzz', { room, team });

      const sound = document.getElementById('buzzerSound');
      sound.currentTime = 0;
      sound.play();
    }

    function reset() {
      socket.emit('reset_buzzer', { room });
    }

    function award() {
      const team = document.getElementById('awardTeamDropdown').value;
      const points = document.getElementById('points').value;
      if (team && points) {
        socket.emit('award_points', { room, team, points });
      }
    }

    function setActive() {
      const team = document.getElementById('activeTeamDropdown').value;
      if (team) {
        socket.emit('set_active_team', { room, team });
      }
    }

    function startBuzzer() {
      socket.emit('start_buzzer_timer', { room });
    }

    function stopBuzzer() {
      socket.emit('stop_buzzer_timer', { room });
    }

    function startQuestionTimer() {
      const seconds = parseInt(document.getElementById('questionSeconds').value);
      if (!isNaN(seconds)) {
        socket.emit('start_question_timer', { room, seconds });
      }
    }

    function stopQuestionTimer() {
      socket.emit('stop_question_timer', { room });
    }

    function resetQuestion() {
      socket.emit('reset_question', { room });
    }

    function saveRoundDetails() {
      const roundName = document.getElementById('roundNameInput').value.trim();
      const numQuestions = document.getElementById('numQuestionsInput').value.trim();
      const marking = document.getElementById('markingInput').value.trim();
      const qtype = document.getElementById('qType')?.value || '';

      socket.emit('save_round_details', {
        room,
        roundName,
        numQuestions,
        marking,
        qtype
      });
    }

    function editScore() {
      const team = document.getElementById('scoreEditDropdown').value;
      const value = parseInt(document.getElementById('scoreEditValue').value);
      if (team && !isNaN(value)) {
        socket.emit('edit_score', { room, team, newScore: value });
      }
    }

    document.getElementById('qType')?.addEventListener('change', function () {
      socket.emit('set_question_type', { room, qtype: this.value });
    });

    socket.on('score_update', scores => {
      const ul = document.getElementById('scoreboard');
      ul.innerHTML = '';
      const teamList = [];

      for (const [teamName, score] of Object.entries(scores)) {
        ul.innerHTML += `<li><strong>${teamName}</strong>: ${score}</li>`;
        teamList.push(teamName);
      }

      document.getElementById('teamList').textContent = teamList.join(', ') || 'None';

      if (role === "admin") {
        updateDropdown('awardTeamDropdown', teamList);
        updateDropdown('activeTeamDropdown', teamList);
        updateDropdown('scoreEditDropdown', teamList);
      }
    });

    socket.on('buzzer_state', data => {
      const { enabled, order } = data;

      const buzzBtn = document.getElementById('buzzBtn');
      if (buzzBtn) {
        buzzBtn.disabled = !enabled || order.includes(team);
      }

      document.getElementById('buzzerStatus').textContent = enabled ? "âœ… Started" : "â›” Stopped";

      const buzzList = document.getElementById('buzzOrderList');
      buzzList.innerHTML = '';
      order.forEach((t, i) => {
        buzzList.innerHTML += `<li>${i + 1}. ${t}</li>`;
      });
    });

    socket.on('question_timer_update', data => {
      clearInterval(questionCountdown);
      document.getElementById('questionTimer').textContent = data.seconds;

      if (data.running) {
        let time = data.seconds;
        questionCountdown = setInterval(() => {
          if (time <= 0) {
            clearInterval(questionCountdown);
          } else {
            time--;
            document.getElementById('questionTimer').textContent = time;
          }
        }, 1000);
      }
    });

    socket.on('room_state', state => {
      document.getElementById('activeDisplay').textContent = state.active_team || '-';
    });

    socket.on('round_details_update', details => {
      console.log("Updated round details received:", details);
      const html = `
        <p><strong>Round Name:</strong> ${details.roundName || '-'}<br/>
        <strong>Type:</strong> ${details.qtype || '-'}<br/>
        <strong>No. of Questions:</strong> ${details.numQuestions || '-'}<br/>
        <strong>Marking:</strong> ${details.marking || '-'}</p>
      `;

      const userRoundDiv = document.getElementById('userRoundDetails');
      const adminRoundDiv = document.getElementById('adminRoundDetails');

      if (userRoundDiv) userRoundDiv.innerHTML = html;
      if (adminRoundDiv) adminRoundDiv.innerHTML = html;
    });



    function updateDropdown(id, items) {
      const select = document.getElementById(id);
      select.innerHTML = items.map(t => `<option value="${t}">${t}</option>`).join('');
    }
  </script>
</body>
</html>
