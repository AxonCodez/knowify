<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Knowify Room - {{ room_id }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" href="/static/styles.css">
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
</head>
<body>
  <audio id="buzzerSound" src="/static/buzzer.mp3" preload="auto"></audio>
  <div class="container">
    <h1>Room: {{ room_id }}</h1>
    <h3>Welcome, {{ name }} ({{ role.upper() }})</h3>

    <!-- Display Panel -->
    <div class="card" style="background: #eaf4ff;">
      <h3>🌀 Current Round: <span id="roundName">-</span></h3>
      <h3>📘 Question Type: <span id="qTypeDisplay">-</span></h3>
      <h3>🎯 Active Team: <span id="activeDisplay">-</span></h3>
      <h3>🕑 Question Timer: <span id="questionTimer">0</span> sec</h3>
      <h3>👥 Joined Teams: <span id="teamList">None</span></h3>
    </div>

    <!-- Admin Controls -->
    <div class="card" id="adminControls" style="display: none;">
      <h2>🧠 Quizmaster Controls</h2>
      <button onclick="addRound()">➕ Add Round</button>
      <button onclick="setRoundName()">📝 Set Round Name</button>

      <hr />

      <h3>🔔 Buzzer Controls:</h3>
      <button onclick="startBuzzer()">▶️ Start Buzzer</button>
      <button onclick="stopBuzzer()">⏸️ Stop Buzzer</button>
      <button onclick="reset()">🔄 Reset Buzzer</button>

      <hr />

      <h3>❓ Question Controls</h3>
      <label>Set Question Type:</label>
      <select id="qType">
        <option value="infinite">Infinite Pounce</option>
        <option value="buzzer">Buzzer Round</option>
        <option value="direct">Direct Question</option>
      </select>

      <br /><br />

      <label>Set Active Team:</label>
      <select id="activeTeamDropdown"></select>
      <button onclick="setActive()">🎯 Set Active</button>

      <br /><br />

      <label>Question Timer (sec):</label>
      <input id="questionSeconds" type="number" placeholder="Seconds">
      <button onclick="startQuestionTimer()">▶️ Start</button>
      <button onclick="stopQuestionTimer()">⏹️ Stop</button>

      <br /><br />
      <button onclick="resetQuestion()">🗑️ Reset Question</button>

      <hr />

      <h3>🏆 Award Points:</h3>
      <select id="awardTeamDropdown"></select>
      <input id="points" type="number" placeholder="Points" />
      <button onclick="award()">✅ Award</button>
    </div>

    <!-- User Buzz Section -->
    <div class="card" id="buzzSection">
      <h2>Buzzer</h2>
      <button onclick="buzz()" id="buzzBtn">🔔 BUZZ</button>
      <span id="buzzerStatus" style="margin-left: 1rem;">⛔</span>
    </div>

    <!-- Scoreboard -->
    <div class="card">
      <h2>Scoreboard</h2>
      <ul id="scoreboard" class="scoreboard-list"></ul>
    </div>

    <!-- Buzz Order -->
    <div class="card">
      <h2>🔔 Buzz Order</h2>
      <ul id="buzzOrderList" class="scoreboard-list"></ul>
    </div>

    <script>
      const role = "{{ role }}";
      const team = "{{ team }}";
      const room = "{{ room_id }}";
      const name = "{{ name }}";
      const socket = io();
      let questionCountdown = null;

      socket.emit('join', { room, team: role === "admin" ? null : team });

      if (role === "admin") {
        document.getElementById('adminControls').style.display = 'block';
        document.getElementById('buzzSection').style.display = 'none';
      }

      function buzz() {
        if (!team) return alert("Only team members can buzz.");
        socket.emit('buzz', { room, team });

        // Play buzzer sound for the user who buzzed
        const sound = document.getElementById('buzzerSound');
        sound.currentTime = 0;
        sound.play();
      }


      function reset() {
        socket.emit('reset_buzzer', { room });
      }

      function award() {
        const team = document.getElementById('awardTeamDropdown').value;
        const points = document.getElementById('points').value;
        if (team && points) {
          socket.emit('award_points', { room, team, points });
        }
      }

      function addRound() {
        socket.emit('add_round', { room });
      }

      function setRoundName() {
        const round = prompt("Enter round name:");
        if (round) socket.emit('set_round_name', { room, round_name: round });
      }

      function setActive() {
        const team = document.getElementById('activeTeamDropdown').value;
        if (team) {
          socket.emit('set_active_team', { room, team });
        }
      }

      function startBuzzer() {
        socket.emit('start_buzzer_timer', { room });
      }

      function stopBuzzer() {
        socket.emit('stop_buzzer_timer', { room });
      }

      function startQuestionTimer() {
        const seconds = parseInt(document.getElementById('questionSeconds').value);
        if (!isNaN(seconds)) {
          socket.emit('start_question_timer', { room, seconds });
        }
      }

      function stopQuestionTimer() {
        socket.emit('stop_question_timer', { room });
      }

      function resetQuestion() {
        socket.emit('reset_question', { room });
      }

      document.getElementById('qType')?.addEventListener('change', function () {
        socket.emit('set_question_type', { room, qtype: this.value });
      });

      socket.on('score_update', scores => {
        const ul = document.getElementById('scoreboard');
        ul.innerHTML = '';
        const teamList = [];

        for (const [teamName, score] of Object.entries(scores)) {
          ul.innerHTML += `<li><strong>${teamName}</strong>: ${score}</li>`;
          teamList.push(teamName);
        }

        document.getElementById('teamList').textContent = teamList.join(', ') || 'None';

        if (role === "admin") {
          updateDropdown('awardTeamDropdown', teamList);
          updateDropdown('activeTeamDropdown', teamList);
        }
      });

      socket.on('buzzer_state', data => {
        const { enabled, order } = data;

        const buzzBtn = document.getElementById('buzzBtn');
        if (buzzBtn) {
          const justBuzzed = !buzzBtn.disabled && order.includes(team);
          buzzBtn.disabled = !enabled || order.includes(team);
          if (justBuzzed) {
            const sound = document.getElementById('buzzerSound');
            sound.currentTime = 0;
            sound.play();
          }
        }

        document.getElementById('buzzerStatus').textContent = enabled ? "✅ Started" : "⛔ Stopped";

        const buzzList = document.getElementById('buzzOrderList');
        buzzList.innerHTML = '';
        order.forEach((t, i) => {
          buzzList.innerHTML += `<li>${i + 1}. ${t}</li>`;
        });
      });

      socket.on('question_timer_update', data => {
        clearInterval(questionCountdown);
        document.getElementById('questionTimer').textContent = data.seconds;

        if (data.running) {
          let time = data.seconds;
          questionCountdown = setInterval(() => {
            if (time <= 0) {
              clearInterval(questionCountdown);
            } else {
              time--;
              document.getElementById('questionTimer').textContent = time;
            }
          }, 1000);
        }
      });

      socket.on('room_state', state => {
        document.getElementById('roundName').textContent = state.current_round || '-';
        document.getElementById('qTypeDisplay').textContent = state.question_type || '-';
        document.getElementById('activeDisplay').textContent = state.active_team || '-';
        document.getElementById('questionTimer').textContent = state.question_timer || 0;
        document.getElementById('buzzerStatus').textContent = state.buzzer_enabled ? "✅ Started" : "⛔ Stopped";
      });

      function updateDropdown(id, items) {
        const select = document.getElementById(id);
        select.innerHTML = items.map(t => `<option value="${t}">${t}</option>`).join('');
      }
    </script>
  </div>
</body>
</html>
